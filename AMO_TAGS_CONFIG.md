# Настройка тегов для Amo CRM

## Обзор

Добавлена возможность автоматически добавлять теги к создаваемым лидам в Amo CRM. Теги могут быть статическими (настраиваются через переменные окружения) и динамическими (генерируются на основе содержимого разговора).

## Переменные окружения

### Статические теги

```bash
# Список статических тегов, которые будут добавлены ко всем лидам
AMO_LEAD_TAGS=Тег1,Тег2,Тег3
```

### Динамические теги

```bash
# Включить/выключить генерацию динамических тегов (по умолчанию: true)
AMO_DYNAMIC_TAGS_ENABLED=true

# Настройка ключевых слов и соответствующих тегов (JSON формат)
AMO_KEYWORD_TAGS_MAP='{
  "вопрос": ["Вопрос"],
  "консультация": ["Консультация", "Услуга"],
  "цена": ["Цена", "Коммерческий"],
  "запись": ["Запись", "Заявка"]
}'
```

## Автоматически добавляемые теги

### Базовые теги
- **RAG Бот** - добавляется ко всем лидам, созданным через RAG бота
- **Новый клиент** / **Повторный клиент** - определяется по наличию существующего контакта в Amo CRM

### Теги на основе интереса
- **Интерес: [значение]** - добавляется тег с указанным интересом клиента

### Теги на основе ключевых слов
По умолчанию система распознает следующие ключевые слова:

| Ключевое слово | Добавляемые теги |
|----------------|------------------|
| вопрос, спросить | Вопрос |
| консультация, консультирование | Консультация |
| информация, информирование | Информация |
| помощь, поддержка | Помощь |
| услуга, сервис | Услуга |
| цена, стоимость, тариф | Цена |
| запись, записаться | Запись |

## Примеры конфигурации

### Простая настройка
```bash
# Добавить статические теги
AMO_LEAD_TAGS=Реклама,Веб-сайт

# Включить динамические теги
AMO_DYNAMIC_TAGS_ENABLED=true
```

### Расширенная настройка
```bash
# Статические теги
AMO_LEAD_TAGS=Маркетинг,Онлайн

# Кастомные ключевые слова
AMO_KEYWORD_TAGS_MAP='{
  "маркетинг": ["Маркетинг", "Реклама"],
  "сайт": ["Веб-разработка", "Технологии"],
  "дизайн": ["Дизайн", "Креатив"],
  "аналитика": ["Аналитика", "Данные"]
}'
```

## Формат API запроса

При создании лида в Amo CRM API v4, теги передаются в поле `tags`:

```json
{
  "name": "Название лида",
  "_embedded": {
    "contacts": [{"id": 123}]
  },
  "custom_fields_values": [...],
  "tags": ["RAG Бот", "Новый клиент", "Консультация", "Услуга"]
}
```

## Тестирование

Для проверки работы тегов запустите тесты:

```bash
go test ./internal/amo -v -run TestSendLeadWithTags
```

## Примечания

1. Теги добавляются только при создании новых лидов
2. Дублирующиеся теги автоматически удаляются
3. Максимальная длина тега в Amo CRM - 255 символов
4. Теги чувствительны к регистру
